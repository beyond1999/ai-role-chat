<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Role Chat · MVP</title>
<style>
  :root{
    --bg:#ffffff;
    --border:#e5e7eb;
    --user:#0a7cff;
    --assistant:#f1f5f9;
    --text:#0f172a;
    --muted:#64748b;
  }
  body{
    margin:0; background:var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", sans-serif;
    color:var(--text); height:100vh; display:flex; flex-direction:column;
  }
  header{
    padding:14px 16px; border-bottom:1px solid var(--border);
    background:var(--bg); z-index:5;
  }
  header h1{font-size:18px; margin:0}
  .row{display:flex; gap:10px; align-items:center; margin:8px 0;}
  .pill{
    background:#f1f5f9; padding:2px 8px; border-radius:999px; font-size:12px; color:#475569;
  }
  .muted{font-size:12px; color:var(--muted);}
  .card{
    border:1px solid var(--border); padding:8px 12px; border-radius:10px; background:#f8fafc;
    margin:8px 0;
  }
  label{font-size:14px; font-weight:600;}
  select{
    flex:1; padding:6px 8px; border:1px solid var(--border); border-radius:6px; font-size:14px;
  }
  #chat{flex:1; overflow:auto; padding:14px 14px 0}
  .row.msg{align-items:flex-end;}
  .row.user{justify-content:flex-end}
  .avatar{
    width:34px;height:34px;border-radius:50%; flex:0 0 34px;
    display:grid; place-items:center; color:#fff; font-weight:700;
  }
  .avatar.user{background:var(--user)}
  .avatar.assistant{background:#94a3b8}
  .bubble{
    max-width:min(78%, 720px);
    padding:10px 12px; line-height:1.6; border-radius:14px;
    box-shadow:0 1px 1px rgba(0,0,0,.04);
    word-wrap:break-word; white-space:pre-wrap;
  }
  .bubble.user{
    background:var(--user); color:#fff;
    border-bottom-right-radius:6px;
  }
  .bubble.assistant{
    background:var(--assistant); color:var(--text);
    border-bottom-left-radius:6px;
  }
  .tools{display:flex; align-items:center; gap:6px; margin-left:4px;}
  .icon-btn{
    border:none; background:transparent; cursor:pointer; padding:4px;
    color:var(--muted); font-size:16px; line-height:1; border-radius:6px;
  }
  .icon-btn:hover{background:#e2e8f0; color:#0f172a}
  #composer{
    border-top:1px solid var(--border); padding:10px; display:flex; gap:8px; align-items:center;
  }
  #mic, #send{
    border:none; background:var(--user); color:#fff; padding:0 14px; height:40px;
    border-radius:10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
  }
  #mic.muted{background:#94a3b8}
  #input{
    flex:1; height:40px; border:1px solid var(--border); border-radius:10px;
    padding:0 12px; font-size:15px; outline:none;
  }
</style>
</head>
<body>
  <header>
    <h1>AI Role Chat</h1>
    <div class="row">
      <span class="pill">MVP</span>
      <span class="muted">语音 → ASR → LLM → TTS（可选人设）</span>
    </div>
    <div class="row card">
      <label>选择角色（Persona）</label>
      <select id="persona">
        <option value="你是一个机灵、爱说“俺老孙”的中文角色。语气轻快，俏皮，善于用比喻，避免学术化长句。">孙悟空（机灵俏皮）</option>
        <option value="你是一个干练的中文虚拟秘书，说话简洁、礼貌、以要点清单输出，善于确认细节。">虚拟秘书（干练简洁）</option>
        <option value="你是一位温柔耐心的中文导游，对城市吃住行很熟，先给概览再给两条推荐路线。">旅行导游（亲切耐心）</option>
      </select>
    </div>
  </header>

  <div id="chat"></div>
  <div id="composer">
    <button id="mic" title="语音输入">🎤</button>
    <input id="input" placeholder="输入你的问题…" />
    <button id="send" title="发送">发送</button>
  </div>

<script>
  const API_URL = "http://127.0.0.1:8000/api/llm/chat";
  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const micBtn = document.getElementById('mic');
  const sendBtn = document.getElementById('send');
  const personaSelect = document.getElementById('persona');

  function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }

  function addMessage(role, text){
    const row = document.createElement('div');
    row.className = `row msg ${role}`;
    const avatar = document.createElement('div');
    avatar.className = `avatar ${role}`;
    avatar.textContent = role==='user'?'我':'Q';
    const bubble = document.createElement('div');
    bubble.className = `bubble ${role}`;
    bubble.textContent = text;
    if(role==='user'){ row.appendChild(bubble); row.appendChild(avatar); }
    else{
      row.appendChild(avatar); row.appendChild(bubble);
      const tools = document.createElement('div'); tools.className='tools';
      const speak = document.createElement('button'); speak.className='icon-btn'; speak.textContent='🔊';
      speak.onclick=()=>{const u=new SpeechSynthesisUtterance(text);u.lang='zh-CN';speechSynthesis.speak(u)};
      tools.appendChild(speak); row.appendChild(tools);
    }
    chat.appendChild(row); scrollToBottom();
  }

  async function sendMessage(){
    const text=input.value.trim(); if(!text)return;
    addMessage('user', text); input.value='';
    const persona=personaSelect.value;
    const messages=[
      {role:'system',content:persona},
      {role:'user',content:text}
    ];
    try{
      const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages,max_tokens:512,temperature:0.7})});
      const data=await res.json();
      addMessage('assistant',data.text||'[无回复]');
    }catch(err){console.error(err);addMessage('assistant','[请求失败]')}
  }
  sendBtn.onclick=sendMessage;
  input.addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage()});

  // 语音识别 → 填写输入框
  let recognition=null,recognizing=false;
  function setupSpeech(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){micBtn.textContent='🎤不可用';micBtn.disabled=true;return;}
    recognition=new SR(); recognition.lang='zh-CN'; recognition.interimResults=true;
    recognition.onstart=()=>{recognizing=true;micBtn.textContent='🛑'};
    recognition.onend=()=>{recognizing=false;micBtn.textContent='🎤'};
    recognition.onresult=ev=>{
      let final='';let interim='';
      for(let i=ev.resultIndex;i<ev.results.length;i++){
        const txt=ev.results[i][0].transcript;
        if(ev.results[i].isFinal)final+=txt; else interim+=txt;
      }
      input.value=final||interim;
    };
  }
  micBtn.onclick=()=>{if(!recognition)setupSpeech(); if(!recognition)return; if(!recognizing)recognition.start(); else recognition.stop();};
  setupSpeech();

  addMessage('assistant','你好，我是千问助手，可以选择不同角色来对话。');
</script>
</body>
</html>
